
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>No Such Thing as Two</title>
  <meta name="author" content="Nathan Wallace">

   
  <meta name="description" content="A blog about Ruby!">
  
  <meta name="keywords" content="">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://nwallace.github.io">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic,700italic|Ubuntu+Mono:400,700,400italic|Open+Sans:300italic,700italic,300,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Averia+Sans+Libre:300,400,700,300italic,400italic,700italic|Roboto+Condensed:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="No Such Thing as Two" type="application/atom+xml">
  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap-collapse.js"></script>
  <script src="/js/modernizr-2.0.js"></script>
  <script src="/js/octopress.js" type="text/javascript"></script>
  <script src="/js/application.js"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-49639013-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header id="title-banner">
  <div id="banner-brand">
    <div class="container">
      <a href="/" title="No Such Thing as Two">No Such Thing as Two</a>
      <h3 class="tagline">0011110000110011</h3>
    </div>
  </div>
  <div class="navbar navbar-inverse navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
        <div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
          <ul class="nav">
  <li >
    <a href="/" title="0011110000110011">
      <i class="icon-home social-navbar"></i>
    </a>
  </li>
  <!---->
</ul>

<ul class="nav pull-right">
  
  <li><a href="http://github.com/nwallace" title="Github Profile"><i class="icon-github-sign social-navbar"></i></a></li>
  
  
  
  <li><a href="http://twitter.com/nosuchthingas2" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i></a></li>
  
  
  
  <li><a href="http://linkedin.com/pub/nathan-wallace/32/40a/352" title="Linkedin Profile"><i class="icon-linkedin-sign social-navbar"></i></a></li>
  
  
  
  
  <li><a href="mailto:nathan@nosuchthingastwo.com" title="Email"><i class="icon-envelope social-navbar"></i></a></li>
  
</ul>

        </div>
      </div>
    </div>
  </div>
</header>


  <div class="container" id="main">
    <div class="row-fluid">
      <div id="content">
        <div class="span8">
          <div class="blog-index">
  
  
    
      <article>
        

  <div class="row-fluid">
    <div class="span12 post-container">
      <h1 class="link"><a href="/blog/2015/07/12/abstractions-via-functions/">Abstractions via functions</a></h1>
      <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2015-07-12T00:00:00-04:00" pubdate data-updated="true">July 12<span>th</span>, 2015</time></h5>
      
      <p>Proponents of functional programming are loud. They preach the gospel of
immutability and simplicity at every opportunity, and make me feel like I need
to repent for my stateful ways.</p>

<p>Needless to say, I am intrigued.</p>

<p>When <a href="https://www.youtube.com/watch?v=rI8tNMsozo0">so</a> <a href="https://www.destroyallsoftware.com/talks/boundaries">many</a> <a href="https://www.youtube.com/watch?v=DMtwq3QtddY">smart</a> <a href="http://codequarterly.com/2011/rich-hickey/">people</a> speak so adamantly about
something, and the only other side of the argument is from people who haven&#39;t
tried it, I tend to believe there&#39;s something to their beliefs.</p>

<p>So, I tried to pick up Clojure. It&#39;s my sixth language, so it wasn&#39;t a struggle
to pick up the syntax. But it has been a <em>huge</em> struggle to learn how to write
web apps without objects to provide layers of abstractions for my code.</p>

<p>In fact, I failed so completely at this that I gave up trying to learn Clojure.
I rewrote the app I had started in Clojure and Clojurescript with Rails and
React.</p>

<p>Fortunately, a friend recommended I read the book <a href="http://www.functionaljavascript.com/">Functional Programming in
Javascript</a> by Michael Fogus. This book was perfect! I already knew
Javascript, so it let me focus on functional programming without being slowed
down by unfamiliar syntax, libraries and parentheses (oh god, the parentheses!).</p>

<p>This book helped me understand the fundamental concept I was missing when I got
fed up with Clojure: how to use functions to create layers of abstraction in
code.</p>

<h2>An example</h2>

<p>The example that drove the idea home for me was when he shows an implementation
of input validation. I&#39;ve implented those several times before in Javascript,
and they always look something like this:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#sign-up-form&quot;</span><span class="p">).</span><span class="nx">submit</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">email</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#email&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
</span><span class='line'>    <span class="nx">password</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#password&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
</span><span class='line'>    <span class="nx">passwordConfirmation</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#passwordConfirmation&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="nx">validateSignUpForm</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>    <span class="c1">// display errors...</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">validateSignUpForm</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;Email is required&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;Password is required&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span> <span class="o">!==</span> <span class="nx">params</span><span class="p">.</span><span class="nx">passwordConfirmation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;Password confirmation doesn&#39;t match&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">errors</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>This code is procedural, full of duplication, and hard to read.</p>

<p>Using the full power of functional programming, we can reimplement
<code>validateSignUpForm</code> like this:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">validateSignUpForm</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">validate</span><span class="p">(</span>
</span><span class='line'>      <span class="nx">params</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">presenceValidation</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;Email is required&quot;</span><span class="p">),</span>
</span><span class='line'>      <span class="nx">presenceValidation</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;Password is required&quot;</span><span class="p">),</span>
</span><span class='line'>      <span class="nx">confirmationValidation</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;passwordConfirmation&quot;</span><span class="p">,</span> <span class="s2">&quot;Password confirmation doesn&#39;t match&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>Much better! This code is declarative instead of procedural. Duplication has
been reduced, and it&#39;s much easier to understand. In fact, it&#39;s strikingly
similar to ActiveRecord validations in Ruby. The key to these wins is
simple: higher-order functions! Let&#39;s take a deeper look.</p>

<h2>Higher-order functions to create abstractions</h2>

<p>In our second version, all <code>validateSignUpForm</code> has to do is call the function
<code>validate</code> with the input from the user and a list of the validations it wants
to check. But what are those validation functions <code>presenceValidation</code> and
<code>confirmationValidation</code>?</p>

<p>Notice the input to these functions. Specifically, note how they don&#39;t receive
the user input data. How the heck are those functions going to validate the
user&#39;s input then? Well, they won&#39;t. But their return values will!</p>

<p>The validation functions will return <em>new</em> functions that will do the actual
work of performing the validation against the user input. These are higher-order
functions at work. Let&#39;s look at one:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">presenceValidation</span><span class="p">(</span><span class="nx">field</span><span class="p">,</span> <span class="nx">errorMessage</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">field</span><span class="p">].</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">errorMessage</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>So we return a function that takes the user input data and returns an error
message if there was an error, or nothing otherwise. Now we&#39;re getting
somewhere.</p>

<p>The final piece to put this all together is the <code>validate</code> function. As we saw,
it receives the user input data and a list of validator functions (making it a
higher-order function as well). So it has all the pieces it needs to return the
array of error messages we&#39;re after.</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">params</span> <span class="cm">/*, validators */</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">errorMessage</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">params</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">errorMessage</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">errorMessage</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">errors</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>Voila! The <code>validate</code> function loops through the validators it&#39;s given, calls
each one with the user input data, and collects the error messages to return.</p>

<h2>How far we&#39;ve come</h2>

<p>Alone, the pieces are simple. Composed, they provide a powerful, elegant,
flexible abstraction for validating user input! It&#39;s also completely stateless,
by the way, so it&#39;s a cinch to test.</p>

<p>I think I finally understand how to use functional programming paradigms to
solve real-world web application problems. The next time I try to tackle
Clojure, I&#39;ll be ready :)</p>

      
      
      
        <div class="pull-right row-fluid">
          
            <a href="/blog/categories/functional-programming/">
              <span class="badge">functional programming</span>
            </a>
          
            <a href="/blog/categories/javascript/">
              <span class="badge">javascript</span>
            </a>
          
        </div>
      
    </div>
  </div>



      </article>
      
        <hr>
      
  
    
      <article>
        

  <div class="row-fluid">
    <div class="span12 post-container">
      <h1 class="link"><a href="/blog/2015/04/20/rspec-macros/">RSpec Macros</a></h1>
      <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2015-04-20T00:00:00-04:00" pubdate data-updated="true">April 20<span>th</span>, 2015</time></h5>
      
      <p>Nobody likes writing boilerplate. It&#39;s repetitive, slow, and just plain boring.
One of the first rules new programmers learn is not to repeat themselves. We do
a good job upholding this principle in our app code, but unit tests are a
different story. In unit tests, it&#39;s often preferable <em>not</em> to write DRY code.
We prefer explicitness and clarity to malleability and reusability.</p>

<p>Usually.</p>

<p>As with all rules in software development, I believe there are exceptions to
this rule. Consider authentication. For every route in your app that requires
authentication, you need to write a controller test to assert that an
unauthenticated user does not have access. I write those tests something like
this (as described <a href="https://www.relishapp.com/rspec/rspec-rails/v/3-2/docs/controller-specs">here</a>).</p>

<div class="no-line-numbers">
<figure class='code'><figcaption><span>spec/controllers/secrets_controller_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">SecretsController</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;GET index&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;requires the user be signed in&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">get</span> <span class="ss">:index</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span> <span class="n">new_session_path</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>I&#39;ve written controller tests exactly like this at least a hundred times over
the past couple of years, and you know what I realized? It&#39;s just
<strong>boilerplate</strong>. It took me a long time to even consider those repetitive tests
duplication (they&#39;re testing different application code, after all), but there
comes a point when the repetition becomes hard to ignore.</p>

<p>I wanted a way to simply declare that my controller action should require the
user to be authenticated, rather than imperatively (and incessantly) writing out
that same unit test again.</p>

<p>I want to write code like this:</p>

<div class="no-line-numbers">
<figure class='code'><figcaption><span>spec/controllers/secrets_controller_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">SecretsController</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;GET index&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it_requires_the_user_be_signed_in</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>We could accomplish something similar with <a href="http://www.relishapp.com/rspec/rspec-core/v/3-2/docs/example-groups/shared-examples">shared examples</a>, but the
language isn&#39;t as expressive as I want. Could we define the method we want
ourselves?</p>

<h2>Parsing the HTTP method and controller action</h2>

<p>Our method will need to send the right HTTP request to the right endpoint, then
assert that the controller sent us to the sign in page. Due to my consistent
organization of my controller specs, by the time we call
<code>it_requires_the_user_be_signed_in</code>, we&#39;ve already written the name of the
controller, the HTTP method and the controller action in our descriptions.</p>

<p>We can get this information out of RSpec&#39;s <code>current_example</code> method within an
example:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">SomeClass</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;some description&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;can introspect its own metadata&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="no">RSpec</span><span class="o">.</span><span class="n">current_example</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:example_group</span><span class="o">][</span><span class="ss">:description</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>        <span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="s2">&quot;some description&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<h2>A simple macro</h2>

<p>RSpec also makes it easy to make extra methods available within an example. But
in this case, we want the method <code>it_requires_the_user_be_signed_in</code> to be
available outside the example blocks. The only way I know to accompish this is
to define the method globally. For organizational purposes, I like to define a
module and include that module into the global namespace in the appropriate
<code>*_helper.rb</code> file:</p>

<div class="no-line-numbers">
<figure class='code'><figcaption><span>spec/support/macros.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Macros</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">it_requires_the_user_be_signed_in</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;requires the user be signed in&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">http_method</span><span class="p">,</span> <span class="n">controller_action</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>        <span class="no">RSpec</span><span class="o">.</span><span class="n">current_example</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:example_group</span><span class="o">][</span><span class="ss">:description</span><span class="o">]</span>
</span><span class='line'>          <span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_sym</span><span class="p">)</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">public_send</span><span class="p">(</span><span class="n">http_method</span><span class="p">,</span> <span class="n">controller_action</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span> <span class="n">new_session_path</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<div class="no-line-numbers">
<figure class='code'><figcaption><span>spec/rails_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># ...</span>
</span><span class='line'>
</span><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;spec/support/**/*.rb&quot;</span><span class="p">)</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="nb">require</span> <span class="n">f</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kp">include</span> <span class="no">Macros</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>With that in place, we&#39;ve implemented the interface we wanted and we can reuse
it anywhere!</p>

<div class="no-line-numbers">
<figure class='code'><figcaption><span>spec/controllers/secrets_controller_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;rails_helper&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">SecretsController</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;GET index&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it_requires_the_user_be_signed_in</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;GET show&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it_requires_the_user_be_signed_in</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">OtherController</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;GET new&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it_requires_the_user_be_signed_in</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;POST create&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it_requires_the_user_be_signed_in</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>It will automatically parse out the right HTTP method and controller action to
invoke, and then run the right assertion.</p>

<h2>Caveats</h2>

<p>So far, controller authentication is the only case where I&#39;ve actually used this
idea, but I&#39;m going to keep an eye out for more opportunities. It&#39;s definitely
a technique to use sparingly, since it sacrifices clarity for convenience. But
in this case, it&#39;s helping me move faster through the boilerplate so I can get
back to the interesting stuff</p>

      
      
      
        <div class="pull-right row-fluid">
          
            <a href="/blog/categories/rails/">
              <span class="badge">rails</span>
            </a>
          
            <a href="/blog/categories/rspec/">
              <span class="badge">rspec</span>
            </a>
          
            <a href="/blog/categories/ruby/">
              <span class="badge">ruby</span>
            </a>
          
        </div>
      
    </div>
  </div>



      </article>
      
        <hr>
      
  
    
      <article>
        

  <div class="row-fluid">
    <div class="span12 post-container">
      <h1 class="link"><a href="/blog/2015/03/31/activerecord-including-only-a-subset-of-associated-records/">Including Only a Subset of Associated Records in ActiveRecord</a></h1>
      <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2015-03-31T00:00:00-04:00" pubdate data-updated="true">March 31<span>st</span>, 2015</time></h5>
      
      <p>Recently, my pair and I were implementing a search feature for administrators to
find customer records. In our app, customers can have many &quot;affiliations&quot; with
external partners, and it&#39;s common to search for a customer by their ID in one
of these external systems. So if an administrator searches with one of these
external IDs, we want to display the matching ID in the search results so they
can know they found the right record.</p>

<p>For example, imagine our database contains two customers, Bob and Alice. Bob has
two affiliations, one with ID 1111 and another with ID 2222. When the
administrator searches for customers with the ID &quot;2222&quot;, we want to display the
following:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Results: (1 of 2)
</span><span class='line'>  Bob (affiliate #2222)</span></code></pre></td></tr></table></div></figure>
</div>

<p>If we&#39;re not careful, however, we might easily write our code such that the page
simply displays Bob&#39;s first affiliation number, rather than the one the admin
was searching for:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%</span> <span class="n">search_results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x"> (affiliate #</span><span class="cp">&lt;%=</span> <span class="n">customer</span><span class="o">.</span><span class="n">affiliations</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="x">)&lt;/li&gt;</span>
</span><span class='line'><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>
</div>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">Results: (1 of 2)</span>
</span><span class='line'><span class="x">  Bob (affiliate #1111)</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>This is confusing! The admin searched for customer with ID 2222, but he got the
customer with ID 1111. Of course, we could display <em>all</em> of the customers&#39;
affiliations, but that could quickly get unwieldy.  We want to preferentially
display the ID the administrator searched for so they know they got the right
customer.</p>

<p>We could do this in Ruby, a la:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%</span> <span class="n">search_results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;li&gt;</span>
</span><span class='line'><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    (affiliate #</span><span class="cp">&lt;%=</span> <span class="n">customer</span><span class="o">.</span><span class="n">affiliations</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="o">=~</span> <span class="sr">/</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:affiliate_id</span><span class="o">]</span><span class="si">}</span><span class="sr">/</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="x">)</span>
</span><span class='line'><span class="x">  &lt;/li&gt;</span>
</span><span class='line'><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>But that sucks. We can do better!</p>

<p>Anyone who knows SQL will tell you that what we want to accomplish is easy with
JOINs:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">customers</span> <span class="k">c</span>
</span><span class='line'><span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">affiliations</span> <span class="n">a</span> <span class="k">ON</span> <span class="n">a</span><span class="p">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">a</span><span class="p">.</span><span class="n">affiliation_id</span> <span class="o">=</span> <span class="s1">&#39;2222&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>and ActiveRecord lets us do JOINs:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">customer</span> <span class="o">=</span>
</span><span class='line'>  <span class="no">Customer</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:affiliations</span><span class="p">)</span>
</span><span class='line'>          <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">affiliations</span><span class="p">:</span> <span class="p">{</span> <span class="n">affiliation_id</span><span class="p">:</span> <span class="s2">&quot;2222&quot;</span> <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>But look at what happens when we read the customer&#39;s affiliations:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">customer</span><span class="o">.</span><span class="n">affiliations</span>
</span><span class='line'><span class="c1"># =&gt; [&lt;Affiliation id: 1, affiliation_id: &quot;1111&quot;, ...&gt;,</span>
</span><span class='line'><span class="c1">#     &lt;Affiliation id: 2, affiliation_id: &quot;2222&quot;, ...&gt;]</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>Despite our <code>where</code> clause to filter out the unwanted affiliations, we still
get all of them when we call <code>customer.affiliations</code>.</p>

<p>The problem is that we&#39;re missing a piece in our ActiveRecord query. The <code>joins</code>
call allows us to reference affiliations in our <code>where</code> call, but ActiveRecord
will only instantiate Customer records from the query results. So when we call
<code>affiliations</code> on the Customer instance, ActiveRecord will go query the database
again without our <code>WHERE</code> clause from before.</p>

<p>To get only the associated records we want, we can leverage another method in
ActiveRecord: <code>includes</code></p>

<p>As you may know, <code>includes</code> is a method that allows us to <a href="http://guides.rubyonrails.org/active_record_querying.html#eager-loading-associations">&quot;eager load&quot;</a>
associated records. This method is usually employed to avoid the <a href="https://secure.phabricator.com/book/phabcontrib/article/n_plus_one/">&quot;N+1 queries&quot;
problem</a>, but we can use it here to basically trick ActiveRecord into
retrieving only a subset of the customer&#39;s affiliations:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">customer</span> <span class="o">=</span>
</span><span class='line'>  <span class="no">Customer</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:affiliations</span><span class="p">)</span>
</span><span class='line'>          <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">affiliations</span><span class="p">:</span> <span class="p">{</span> <span class="n">affiliation_id</span><span class="p">:</span> <span class="s2">&quot;2222&quot;</span> <span class="p">})</span>
</span><span class='line'>          <span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:affiliations</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">customer</span><span class="o">.</span><span class="n">affiliations</span>
</span><span class='line'><span class="c1"># =&gt; [&lt;Affiliation id: 2, affiliation_id: &quot;2222&quot;, ...&gt;]</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>It works! We get all the customers with affiliations matching the given id, and
we didn&#39;t get any of the other affiliations of the customer.</p>

<p>The reason this works is that <code>includes</code> tells ActiveRecord to instantiate the
customer&#39;s affiliations association using the data included via the <code>JOIN</code>
clause in the query.  ActiveRecord will do and then cache the associated records
so that when you call <code>affiliations</code> on a Customer it does not query the
database again. This caching behavior is what allows <code>includes</code> to address the
N+1 problem and also what allows us to retrieve only a subset of a record&#39;s
association.</p>

      
      
      
        <div class="pull-right row-fluid">
          
            <a href="/blog/categories/active-record/">
              <span class="badge">active record</span>
            </a>
          
            <a href="/blog/categories/rails/">
              <span class="badge">rails</span>
            </a>
          
            <a href="/blog/categories/ruby/">
              <span class="badge">ruby</span>
            </a>
          
        </div>
      
    </div>
  </div>



      </article>
      
        <hr>
      
  
    
      <article>
        

  <div class="row-fluid">
    <div class="span12 post-container">
      <h1 class="link"><a href="/blog/2015/01/28/aw-snap-ubuntu-core/">Aw snap! Ubuntu Core</a></h1>
      <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2015-01-28T00:00:00-05:00" pubdate data-updated="true">January 28<span>th</span>, 2015</time></h5>
      
      <p>Docker! DevOps! Containerization! Buzz words! Containerization is sweeping the
community like thick-rimmed glasses and JavaScript transpilers. Since I don&#39;t
want the cool kids to realize I&#39;m a hipster-imposter, I figured I&#39;d better get
ahead of this trend while it&#39;s still cool.</p>

<p>But where to start?</p>

<h2>Ubuntu Core</h2>

<p>I probably should start learning the basics of Docker first, but Ubuntu just
released a new spin they&#39;re calling Core. Ubuntu Core, like
<a href="https://coreos.com/">CoreOS</a> and <a href="http://www.projectatomic.io/">Project
Atomic</a>, is a Linux distribution optimized for
running app containers. I chose to try out Ubuntu Core because I just read
<a href="http://0pointer.net/blog/revisiting-how-we-put-together-linux-systems.html">Lennart Pottering&#39;s blog post about OS
design</a>
and heard from <del>some rando on Hacker News</del> a reputable source that
Ubuntu Core is an early take on that philosophy. It&#39;s got all kinds of
goodness, including transactional updates, systemd and container runtime
agnosticism (I have a lot of issues with Docker, and much prefer the promise of
something like <a href="https://coreos.com/blog/rocket/">Rocket</a>).</p>

<h2>Getting Down and Dirty</h2>

<p>To try it out, download the OVA image from <a href="http://www.ubuntu.com/cloud/tools/snappy#snappy-ova">this
page</a> and open it with
<a href="https://www.virtualbox.org/">VirtualBox</a> (login and password both <code>ubuntu</code>).
There&#39;s a <a href="http://developer.ubuntu.com/en/snappy/#tour">quick overview of Ubuntu
Core</a> on Ubuntu&#39;s developer site
that walks you through an introduction to <code>snappy</code>, the tool for managing your
containers.</p>

<p>The guide explains how to install app containers with Docker. There&#39;s an example
app for displaying <a href="http://xkcd.com/">xkcd</a> comics. You can install it with:</p>

<p><code>$ sudo snappy install xkcd-webserver</code></p>

<p>The part the guide left out was what the heck that command does! As described
<a href="http://developer.ubuntu.com/en/snappy/#snap-developers">here</a>, Ubuntu Core
installs app files in <code>/apps/&lt;package&gt;/&lt;version&gt;</code>, then symlinks
<code>/apps/&lt;package&gt;/current</code> to the new version (just like Capistrano).</p>

<div class="no-line-numbers">
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ls -l /apps/xkcd-webserver/current
</span><span class='line'>  =&gt; lrwxrwxrwx 1 clickpkg clickpkg 5 Jan 28 22:01 /apps/xkcd-webserver/current -&gt; 0.3.1
</span><span class='line'>$ find /apps/xkcd-webserver -type d
</span><span class='line'>  =&gt; /apps/xkcd-webserver
</span><span class='line'>     /apps/xkcd-webserver/0.3.1
</span><span class='line'>     /apps/xkcd-webserver/0.3.1/.click
</span><span class='line'>     /apps/xkcd-webserver/0.3.1/.click/triggers
</span><span class='line'>     /apps/xkcd-webserver/0.3.1/.click/updates
</span><span class='line'>     /apps/xkcd-webserver/0.3.1/.click/info
</span><span class='line'>     /apps/xkcd-webserver/0.3.1/www
</span><span class='line'>     /apps/xkcd-webserver/0.3.1/meta
</span><span class='line'>     /apps/xkcd-webserver/0.3.1/bin</span></code></pre></td></tr></table></div></figure>
</div>

<p>Ubuntu Core installs app binaries to <code>/apps/&lt;package&gt;/&lt;version&gt;/bin</code>. If we look
inside the <code>bin</code> directory for our xkcd app, we&#39;ll find the python script that
boots up the webserver:</p>

<div class="no-line-numbers">
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ less /apps/xkcd-webserver/current/bin/xkcd-webserver
</span><span class='line'>  =&gt; !#/usr/bin/python3
</span><span class='line'>     ...</span></code></pre></td></tr></table></div></figure>
</div>

<p>In fact, the OS has already started the app for us:</p>

<div class="no-line-numbers">
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ps aux | grep xkcd
</span><span class='line'>  =&gt; root ... /usr/bin/python3 /apps/xkcd-webserver/0.3.1/bin/xkcd-webserver</span></code></pre></td></tr></table></div></figure>
</div>

<p>To see the app running, set up a port forwarding rule with VirtualBox so you
can navigate to port 80 on the virtual machine. From the VirtualBox VM Manager,
click your Ubuntu Core VM on the left and choose &quot;Settings&quot;. Under &quot;Network&quot; &gt;
&quot;Port Forwarding&quot;, click the plus sign to add a new rule to forward a Host
port (I chose 8080) to port 80 on the Guest. Then navigate to localhost:8080 in
your browser to see the app in all its glory.</p>

<p>Congratulations! You&#39;re running Docker apps on Ubuntu Core! Just be careful not
to tell your boss at work, unless you&#39;re ready to become &quot;the DevOps gal/guy&quot; ;)</p>

      
      
      
        <div class="pull-right row-fluid">
          
            <a href="/blog/categories/containers/">
              <span class="badge">containers</span>
            </a>
          
            <a href="/blog/categories/docker/">
              <span class="badge">docker</span>
            </a>
          
            <a href="/blog/categories/linux/">
              <span class="badge">linux</span>
            </a>
          
            <a href="/blog/categories/ubuntu/">
              <span class="badge">ubuntu</span>
            </a>
          
            <a href="/blog/categories/ubuntu-core/">
              <span class="badge">ubuntu core</span>
            </a>
          
        </div>
      
    </div>
  </div>



      </article>
      
        <hr>
      
  
    
      <article>
        

  <div class="row-fluid">
    <div class="span12 post-container">
      <h1 class="link"><a href="/blog/2014/07/10/sql-escapades-over-and-partition-by/">SQL Escapades: OVER and PARTITION BY</a></h1>
      <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2014-07-10T00:00:00-04:00" pubdate data-updated="true">July 10<span>th</span>, 2014</time></h5>
      
      <p>On a handful of occasions I&#39;ve needed to write a query that returns only one
record per group of records. Like, needing to retrieve one customer record per
address so we can send some mail.</p>

<p>Typically, you can accomplish these types of queries using <code>GROUP BY</code>
statements. Maybe something like this:</p>

<div class="no-line-numbers">
<figure class='code'><figcaption><span>Unique Addresses</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span>   <span class="n">street_address</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> <span class="k">state</span>
</span><span class='line'><span class="k">FROM</span>     <span class="n">customers</span>
</span><span class='line'><span class="k">GROUP</span> <span class="k">BY</span> <span class="n">street_address</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> <span class="k">state</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>But what if we need to include the customers&#39; first and last names in the
results? We can&#39;t add the name field to our <code>SELECT</code> because it&#39;s not in our
<code>GROUP BY</code> clause. And we don&#39;t want to run an aggregate function on the names
because we can&#39;t guarantee the functions will return a first and last name that
match. This problem is that a grouping query isn&#39;t want we want to do. We don&#39;t
want to get back aggregate data. We want to get back data specific to one
customer &#8211; we just want one per address.</p>

<p>So what do we do?</p>

<h2>OVER</h2>

<p>The <code>OVER</code> clause in SQL is a feature that allows you to retrieve aggregate data
together with data from individual rows. For example, if you want to return all
sales records and (for some reason) the total revenue of all sales with each
record, you could do this:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="n">OVER</span><span class="p">()</span> <span class="k">AS</span> <span class="n">total_revenue</span>
</span><span class='line'><span class="k">FROM</span>   <span class="n">sales</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>While this might be useful occasionally, it&#39;s not helpful to our goal of
retrieving one customer per address. We need&#8230;</p>

<h2>PARTITION BY</h2>

<p>The <code>OVER</code> function doesn&#39;t have to be empty, as above. It can take arguments!
<code>PARTITION BY</code> is one such argument that will run the aggregate function against
the table grouped by the the given partitioning column.</p>

<p>So say we want to get revenue subtotals by year instead of a grand total for
our sales records. In Postgres we could to this:</p>

<div class="no-line-numbers no-code-title">
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">date_part</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">created_at</span><span class="p">))</span> <span class="k">AS</span> <span class="n">monthly_subtotal</span>
</span><span class='line'><span class="k">FROM</span>   <span class="n">sales</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<h2>Putting It Together</h2>

<p>Let&#39;s get back to our original question of retrieving one customer per address.
Have you figured it out yet? We can partition by the customer&#39;s address! Then
it&#39;s a simple matter of applying the <code>row_number()</code> aggregate function to the
partitioned results to select only one customer per address.</p>

<div class="no-line-numbers">
<figure class='code'><figcaption><span>One Customer Per Address</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">results</span><span class="p">.</span><span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="p">(</span>
</span><span class='line'>    <span class="k">SELECT</span> <span class="k">c</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">street_address</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> <span class="k">state</span><span class="p">)</span> <span class="k">AS</span> <span class="n">row_num</span>
</span><span class='line'>    <span class="k">FROM</span>   <span class="n">customers</span> <span class="k">c</span>
</span><span class='line'>  <span class="p">)</span> <span class="n">results</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">results</span><span class="p">.</span><span class="n">row_number</span> <span class="o">=</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>Voila! We&#39;ve got one full customer record per address!</p>

<p>Let&#39;s do another example to drive it home. Say we&#39;re running a news database
with &quot;stories&quot; that each belong to a single &quot;category&quot;. Let&#39;s write a query to
retrieve the five most recent story titles from each category.</p>

<div class="no-line-numbers">
<figure class='code'><figcaption><span>Top 5 Story Titles Per Category</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">title</span><span class="p">,</span> <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">category_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">created_at</span> <span class="k">DESC</span><span class="p">)</span> <span class="k">AS</span> <span class="n">row_num</span>
</span><span class='line'><span class="k">FROM</span>   <span class="n">stories</span>
</span><span class='line'><span class="k">WHERE</span>  <span class="n">row_num</span> <span class="o">&lt;=</span> <span class="mi">5</span>
</span></code></pre></td></tr></table></div></figure>
</div>

<p>I&#39;d love to see other takes on how to do these queries, so please leave comments
below if you&#39;ve got other ideas!</p>

      
      
      
        <div class="pull-right row-fluid">
          
            <a href="/blog/categories/sql/">
              <span class="badge">sql</span>
            </a>
          
        </div>
      
    </div>
  </div>



      </article>
      
  
  <div class="pagination">
    
    <a class="prev" href="/blog/page/2/">&larr; Older</a>
    

    
  </div>
</div>


        </div>
        <aside class="span4 sidebar">
          
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:nwallace.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>



          <section>
  <h3>About</h3>
  <p>I'm Nathan Wallace, and this is my blog about web development.</p>
  <p class="clearfix"><a class="pull-right" href="/about">More &rarr;</a></p>
</section>

          <section>
  <h3>Recent Posts</h3>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/07/12/abstractions-via-functions/">Abstractions via functions</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/20/rspec-macros/">RSpec Macros</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/31/activerecord-including-only-a-subset-of-associated-records/">Including Only a Subset of Associated Records in ActiveRecord</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/28/aw-snap-ubuntu-core/">Aw snap! Ubuntu Core</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/10/sql-escapades-over-and-partition-by/">SQL Escapades: OVER and PARTITION BY</a>
      </li>
    
  </ul>
</section>

        </aside>
      </div>
    </div>
    <footer class="footer-page" role="contentinfo">
      <p>
  Copyright &copy; 2015 - Nathan Wallace -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>


    </footer>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'nosuchthingastwo';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
